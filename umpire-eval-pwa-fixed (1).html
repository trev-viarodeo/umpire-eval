<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Umpire Evaluation</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* High contrast for outdoor use */
        .outdoor-button {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        /* PWA styles */
        html, body {
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Star rating */
        .star-rating input[type="radio"] {
            display: none;
        }
        
        .star-rating label {
            cursor: pointer;
            font-size: 2rem;
        }
        
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #fbbf24;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div x-data="umpireApp()" x-init="init()" class="container mx-auto px-4 py-6 max-w-md">
        
        <!-- Login Screen -->
        <div x-show="currentScreen === 'login'" class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold text-center mb-6">Umpire Evaluation</h1>
            <form @submit.prevent="login()">
                <label class="block text-lg font-medium mb-2">Enter PIN</label>
                <input 
                    type="tel" 
                    x-model="pin" 
                    maxlength="4" 
                    pattern="[0-9]{4}"
                    class="w-full text-center text-3xl p-4 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    placeholder="0000"
                    inputmode="numeric"
                    required
                >
                <button 
                    type="submit" 
                    class="w-full mt-4 bg-blue-600 text-white text-xl font-bold py-4 rounded-lg outdoor-button hover:bg-blue-700 transition"
                >
                    Login
                </button>
            </form>
            <div x-show="loginError" class="mt-4 text-red-600 text-center" x-text="loginError"></div>
        </div>

        <!-- Umpire Selection -->
        <div x-show="currentScreen === 'selectUmpire'" class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">Select Umpire</h2>
            <input 
                type="search" 
                x-model="umpireSearch" 
                placeholder="Search by name or email..."
                class="w-full p-3 border rounded-lg mb-4"
            >
            <div class="max-h-96 overflow-y-auto">
                <template x-for="umpire in filteredUmpires" :key="umpire.id">
                    <button 
                        @click="selectUmpire(umpire)"
                        class="w-full text-left p-3 hover:bg-gray-100 border-b transition"
                    >
                        <div class="font-medium" x-text="umpire.name"></div>
                        <div class="text-sm text-gray-600" x-text="umpire.email"></div>
                    </button>
                </template>
            </div>
        </div>

        <!-- Pre-Game Questions -->
        <div x-show="currentScreen === 'preGame'" class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">Pre-Game Evaluation</h2>
            <div class="text-sm text-gray-600 mb-4">Umpire: <span x-text="selectedUmpire?.name"></span></div>
            
            <div class="space-y-4">
                <div>
                    <label class="block font-medium mb-2">Was the umpire on time?</label>
                    <div class="flex gap-4">
                        <button 
                            @click="preGameData.onTime = true"
                            :class="preGameData.onTime === true ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >Yes</button>
                        <button 
                            @click="preGameData.onTime = false"
                            :class="preGameData.onTime === false ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >No</button>
                    </div>
                </div>

                <div>
                    <label class="block font-medium mb-2">Was the umpire in proper uniform?</label>
                    <div class="flex gap-4">
                        <button 
                            @click="preGameData.properUniform = true"
                            :class="preGameData.properUniform === true ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >Yes</button>
                        <button 
                            @click="preGameData.properUniform = false"
                            :class="preGameData.properUniform === false ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >No</button>
                    </div>
                </div>

                <div>
                    <label class="block font-medium mb-2">Did the game start on time (within umpire's control)?</label>
                    <div class="flex gap-4">
                        <button 
                            @click="preGameData.gameOnTime = true"
                            :class="preGameData.gameOnTime === true ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >Yes</button>
                        <button 
                            @click="preGameData.gameOnTime = false"
                            :class="preGameData.gameOnTime === false ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >No</button>
                    </div>
                </div>
            </div>

            <button 
                @click="startPitchEvaluation()"
                :disabled="!isPreGameComplete()"
                class="w-full mt-6 bg-blue-600 text-white text-xl font-bold py-4 rounded-lg outdoor-button hover:bg-blue-700 disabled:bg-gray-400 transition"
            >
                Start Pitch Evaluation
            </button>
        </div>

        <!-- Pitch Evaluation -->
        <div x-show="currentScreen === 'pitch'" class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Pitch <span x-text="pitchCount"></span></h2>
                <button 
                    @click="endGame()"
                    class="text-blue-600 font-medium"
                >End Game</button>
            </div>

            <!-- Pitch Outcome Selection -->
            <div x-show="!currentPitch.outcome">
                <label class="block font-medium mb-3">Select pitch outcome:</label>
                <div class="grid grid-cols-2 gap-3">
                    <button 
                        @click="selectOutcome('ball')"
                        class="bg-yellow-500 text-white py-4 rounded-lg font-bold outdoor-button hover:bg-yellow-600 transition"
                    >Ball</button>
                    <button 
                        @click="selectOutcome('strike')"
                        class="bg-red-600 text-white py-4 rounded-lg font-bold outdoor-button hover:bg-red-700 transition"
                    >Strike</button>
                    <button 
                        @click="selectOutcome('foul')"
                        class="bg-orange-500 text-white py-4 rounded-lg font-bold outdoor-button hover:bg-orange-600 transition"
                    >Foul Ball</button>
                    <button 
                        @click="selectOutcome('inPlay')"
                        class="bg-green-600 text-white py-4 rounded-lg font-bold outdoor-button hover:bg-green-700 transition"
                    >In Play</button>
                </div>
            </div>

            <!-- In Play Location -->
            <div x-show="currentPitch.outcome === 'inPlay' && !currentPitch.location">
                <div class="flex items-center justify-between mb-3">
                    <label class="block font-medium">Where was the ball hit?</label>
                    <button 
                        @click="goBack()"
                        class="text-blue-600 text-sm"
                    >‚Üê Back</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button 
                        @click="currentPitch.location = 'infield'; showContextualQuestions()"
                        class="bg-blue-600 text-white py-4 rounded-lg font-bold outdoor-button hover:bg-blue-700 transition"
                    >Infield</button>
                    <button 
                        @click="currentPitch.location = 'outfield'; askOutfieldType()"
                        class="bg-blue-600 text-white py-4 rounded-lg font-bold outdoor-button hover:bg-blue-700 transition"
                    >Outfield</button>
                </div>
            </div>

            <!-- Outfield Type -->
            <div x-show="currentScreen === 'pitch' && currentPitch.outcome === 'inPlay' && currentPitch.location === 'outfield' && !currentPitch.outfieldType">
                <div class="flex items-center justify-between mb-3">
                    <label class="block font-medium">What happened in the outfield?</label>
                    <button 
                        @click="backFromOutfieldType()"
                        class="text-blue-600 text-sm"
                    >‚Üê Back</button>
                </div>
                <div class="space-y-3">
                    <button 
                        @click="setOutfieldType('caught')"
                        class="w-full bg-blue-600 text-white py-4 rounded-lg font-bold outdoor-button hover:bg-blue-700 transition"
                    >Caught for Out</button>
                    <button 
                        @click="setOutfieldType('dropped')"
                        class="w-full bg-blue-600 text-white py-4 rounded-lg font-bold outdoor-button hover:bg-blue-700 transition"
                    >Hit/Dropped</button>
                    <button 
                        @click="setOutfieldType('nearLine')"
                        class="w-full bg-blue-600 text-white py-4 rounded-lg font-bold outdoor-button hover:bg-blue-700 transition"
                    >Hit Near Foul Line</button>
                </div>
            </div>

            <!-- Contextual Questions -->
            <div x-show="showingContextual" class="mt-4 space-y-4">
                <!-- Show selected outcome at top -->
                <div class="bg-gray-100 p-3 rounded-lg flex items-center justify-between">
                    <div>
                        <span class="font-medium">Outcome: </span>
                        <span class="font-bold capitalize" x-text="getOutcomeDisplay()"></span>
                    </div>
                    <button 
                        @click="goBack()"
                        class="text-blue-600 text-sm"
                    >‚Üê Back</button>
                </div>

                <!-- Strike Flow -->
                <div x-show="currentPitch.outcome === 'strike' && !currentPitch.countAsked">
                    <label class="block font-medium mb-2">Did they give the correct hand signal for strike?</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            @click="currentPitch.handSignals = 'improper'; checkAutoProgressToCount()"
                            :class="currentPitch.handSignals === 'improper' ? 'bg-yellow-500 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Improper</button>
                        <button 
                            @click="currentPitch.handSignals = 'none'; checkAutoProgressToCount()"
                            :class="currentPitch.handSignals === 'none' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >None</button>
                        <button 
                            @click="currentPitch.handSignals = 'proper'; checkAutoProgressToCount()"
                            :class="currentPitch.handSignals === 'proper' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Proper</button>
                    </div>
                </div>

                <div x-show="currentPitch.outcome === 'strike' && !currentPitch.countAsked">
                    <label class="block font-medium mb-2">Did they announce "strike"?</label>
                    <div class="flex gap-4">
                        <button 
                            @click="currentPitch.announcedCall = false; checkAutoProgressToCount()"
                            :class="currentPitch.announcedCall === false ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >No</button>
                        <button 
                            @click="currentPitch.announcedCall = true; checkAutoProgressToCount()"
                            :class="currentPitch.announcedCall === true ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >Yes</button>
                    </div>
                </div>

                <!-- Foul Ball Flow -->
                <div x-show="currentPitch.outcome === 'foul' && !currentPitch.countAsked">
                    <label class="block font-medium mb-2">Was the umpire in proper position?</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            @click="currentPitch.position = 'bad'; checkAutoProgressToCount()"
                            :class="currentPitch.position === 'bad' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Bad</button>
                        <button 
                            @click="currentPitch.position = 'ok'; checkAutoProgressToCount()"
                            :class="currentPitch.position === 'ok' ? 'bg-yellow-500 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >OK</button>
                        <button 
                            @click="currentPitch.position = 'good'; checkAutoProgressToCount()"
                            :class="currentPitch.position === 'good' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Good</button>
                    </div>
                </div>

                <div x-show="currentPitch.outcome === 'foul' && !currentPitch.countAsked">
                    <label class="block font-medium mb-2">Did they give the proper hand signal for foul ball?</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            @click="currentPitch.handSignals = 'improper'; checkAutoProgressToCount()"
                            :class="currentPitch.handSignals === 'improper' ? 'bg-yellow-500 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Improper</button>
                        <button 
                            @click="currentPitch.handSignals = 'none'; checkAutoProgressToCount()"
                            :class="currentPitch.handSignals === 'none' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >None</button>
                        <button 
                            @click="currentPitch.handSignals = 'proper'; checkAutoProgressToCount()"
                            :class="currentPitch.handSignals === 'proper' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Proper</button>
                    </div>
                </div>

                <div x-show="currentPitch.outcome === 'foul' && !currentPitch.countAsked">
                    <label class="block font-medium mb-2">Did they announce "Foul Ball"?</label>
                    <div class="flex gap-4">
                        <button 
                            @click="currentPitch.announcedCall = false; checkAutoProgressToCount()"
                            :class="currentPitch.announcedCall === false ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >No</button>
                        <button 
                            @click="currentPitch.announcedCall = true; checkAutoProgressToCount()"
                            :class="currentPitch.announcedCall === true ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >Yes</button>
                    </div>
                </div>

                <!-- Ball Flow (no specific questions, goes straight to count) -->

                <!-- In Play - Infield -->
                <div x-show="currentPitch.outcome === 'inPlay' && currentPitch.location === 'infield'">
                    <label class="block font-medium mb-2">What was the call?</label>
                    <div class="flex gap-4">
                        <button 
                            @click="currentPitch.callMade = 'out'"
                            :class="currentPitch.callMade === 'out' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-bold outdoor-button transition"
                        >OUT</button>
                        <button 
                            @click="currentPitch.callMade = 'safe'"
                            :class="currentPitch.callMade === 'safe' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-bold outdoor-button transition"
                        >SAFE</button>
                    </div>
                </div>

                <div x-show="currentPitch.outcome === 'inPlay' && currentPitch.location === 'infield'">
                    <label class="block font-medium mb-2">
                        <span x-show="!currentPitch.callMade">Did they use the correct hand signal?</span>
                        <span x-show="currentPitch.callMade">Did they use the correct hand signal for <span x-text="currentPitch.callMade" class="uppercase"></span>?</span>
                    </label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            @click="currentPitch.handSignals = 'improper'"
                            :class="currentPitch.handSignals === 'improper' ? 'bg-yellow-500 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Improper</button>
                        <button 
                            @click="currentPitch.handSignals = 'none'"
                            :class="currentPitch.handSignals === 'none' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >None</button>
                        <button 
                            @click="currentPitch.handSignals = 'proper'"
                            :class="currentPitch.handSignals === 'proper' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Proper</button>
                    </div>
                </div>

                <div x-show="currentPitch.outcome === 'inPlay' && currentPitch.location === 'infield'">
                    <label class="block font-medium mb-2">Was the umpire in proper position?</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            @click="currentPitch.position = 'bad'"
                            :class="currentPitch.position === 'bad' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Bad</button>
                        <button 
                            @click="currentPitch.position = 'ok'"
                            :class="currentPitch.position === 'ok' ? 'bg-yellow-500 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >OK</button>
                        <button 
                            @click="currentPitch.position = 'good'"
                            :class="currentPitch.position === 'good' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Good</button>
                    </div>
                </div>

                <div x-show="currentPitch.outcome === 'inPlay' && currentPitch.location === 'infield'">
                    <label class="block font-medium mb-2">Did they call time appropriately?</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            @click="currentPitch.timeCall = 'bad'"
                            :class="currentPitch.timeCall === 'bad' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Bad</button>
                        <button 
                            @click="currentPitch.timeCall = 'ok'"
                            :class="currentPitch.timeCall === 'ok' ? 'bg-yellow-500 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >OK</button>
                        <button 
                            @click="currentPitch.timeCall = 'good'"
                            :class="currentPitch.timeCall === 'good' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Good</button>
                    </div>
                </div>

                <!-- In Play - Outfield (based on type) -->
                <div x-show="currentPitch.outcome === 'inPlay' && currentPitch.location === 'outfield' && currentPitch.outfieldType === 'caught'">
                    <label class="block font-medium mb-2">Did they make the proper signal for the catch?</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            @click="currentPitch.handSignals = 'improper'"
                            :class="currentPitch.handSignals === 'improper' ? 'bg-yellow-500 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Improper</button>
                        <button 
                            @click="currentPitch.handSignals = 'none'"
                            :class="currentPitch.handSignals === 'none' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >None</button>
                        <button 
                            @click="currentPitch.handSignals = 'proper'"
                            :class="currentPitch.handSignals === 'proper' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Proper</button>
                    </div>
                </div>

                <div x-show="currentPitch.outcome === 'inPlay' && currentPitch.location === 'outfield' && currentPitch.outfieldType === 'caught'">
                    <label class="block font-medium mb-2">Did they announce "Out"?</label>
                    <div class="flex gap-4">
                        <button 
                            @click="currentPitch.announcedCall = false"
                            :class="currentPitch.announcedCall === false ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >No</button>
                        <button 
                            @click="currentPitch.announcedCall = true"
                            :class="currentPitch.announcedCall === true ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >Yes</button>
                    </div>
                </div>

                <div x-show="currentPitch.outcome === 'inPlay' && currentPitch.location === 'outfield' && currentPitch.outfieldType === 'caught'">
                    <label class="block font-medium mb-2">Was the umpire in proper position?</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            @click="currentPitch.position = 'bad'"
                            :class="currentPitch.position === 'bad' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Bad</button>
                        <button 
                            @click="currentPitch.position = 'ok'"
                            :class="currentPitch.position === 'ok' ? 'bg-yellow-500 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >OK</button>
                        <button 
                            @click="currentPitch.position = 'good'"
                            :class="currentPitch.position === 'good' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Good</button>
                    </div>
                </div>

                <div x-show="currentPitch.outcome === 'inPlay' && currentPitch.location === 'outfield' && currentPitch.outfieldType === 'nearLine'">
                    <label class="block font-medium mb-2">Did they give a fair ball signal?</label>
                    <div class="flex gap-4">
                        <button 
                            @click="currentPitch.fairBallSignal = true"
                            :class="currentPitch.fairBallSignal === true ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >Yes</button>
                        <button 
                            @click="currentPitch.fairBallSignal = false"
                            :class="currentPitch.fairBallSignal === false ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >No</button>
                    </div>
                </div>

                <!-- Secondary Play Question - for ALL outfield types -->
                <div x-show="currentPitch.outcome === 'inPlay' && currentPitch.location === 'outfield'">
                    <label class="block font-medium mb-2">Was a secondary play made in the infield?</label>
                    <div class="flex gap-4">
                        <button 
                            @click="currentPitch.secondaryPlay = false"
                            :class="currentPitch.secondaryPlay === false ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >No</button>
                        <button 
                            @click="currentPitch.secondaryPlay = true"
                            :class="currentPitch.secondaryPlay === true ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                        >Yes</button>
                    </div>
                </div>

                <!-- Secondary Play Questions (shown inline when secondaryPlay is true) -->
                <div x-show="currentPitch.secondaryPlay === true && currentPitch.location === 'outfield'">
                    <div class="border-t pt-4 mt-4">
                        <h3 class="font-bold text-lg mb-3">Secondary Play in Infield</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block font-medium mb-2">What was the call?</label>
                                <div class="flex gap-4">
                                    <button 
                                        @click="currentPitch.secondaryCallMade = 'out'"
                                        :class="currentPitch.secondaryCallMade === 'out' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                                        class="flex-1 py-3 rounded-lg font-bold outdoor-button transition"
                                    >OUT</button>
                                    <button 
                                        @click="currentPitch.secondaryCallMade = 'safe'"
                                        :class="currentPitch.secondaryCallMade === 'safe' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                                        class="flex-1 py-3 rounded-lg font-bold outdoor-button transition"
                                    >SAFE</button>
                                </div>
                            </div>

                            <div x-show="currentPitch.secondaryCallMade">
                                <label class="block font-medium mb-2">Did they use the correct hand signal?</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button 
                                        @click="currentPitch.secondaryHandSignals = 'improper'"
                                        :class="currentPitch.secondaryHandSignals === 'improper' ? 'bg-yellow-500 text-white' : 'bg-gray-200'"
                                        class="py-3 rounded-lg font-medium outdoor-button transition"
                                    >Improper</button>
                                    <button 
                                        @click="currentPitch.secondaryHandSignals = 'none'"
                                        :class="currentPitch.secondaryHandSignals === 'none' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                                        class="py-3 rounded-lg font-medium outdoor-button transition"
                                    >None</button>
                                    <button 
                                        @click="currentPitch.secondaryHandSignals = 'proper'"
                                        :class="currentPitch.secondaryHandSignals === 'proper' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                                        class="py-3 rounded-lg font-medium outdoor-button transition"
                                    >Proper</button>
                                </div>
                            </div>

                            <div x-show="currentPitch.secondaryCallMade">
                                <label class="block font-medium mb-2">Were they in proper position for the secondary play?</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button 
                                        @click="currentPitch.secondaryPosition = 'bad'"
                                        :class="currentPitch.secondaryPosition === 'bad' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                                        class="py-3 rounded-lg font-medium outdoor-button transition"
                                    >Bad</button>
                                    <button 
                                        @click="currentPitch.secondaryPosition = 'ok'"
                                        :class="currentPitch.secondaryPosition === 'ok' ? 'bg-yellow-500 text-white' : 'bg-gray-200'"
                                        class="py-3 rounded-lg font-medium outdoor-button transition"
                                    >OK</button>
                                    <button 
                                        @click="currentPitch.secondaryPosition = 'good'"
                                        :class="currentPitch.secondaryPosition === 'good' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                                        class="py-3 rounded-lg font-medium outdoor-button transition"
                                    >Good</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Time Call Question - for ALL outfield plays at the very end -->
                <div x-show="currentPitch.outcome === 'inPlay' && currentPitch.location === 'outfield' && currentPitch.secondaryPlay !== null && (!currentPitch.secondaryPlay || (currentPitch.secondaryPlay && currentPitch.secondaryPosition))">
                    <label class="block font-medium mb-2">Did they call time appropriately?</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            @click="currentPitch.timeCall = 'bad'"
                            :class="currentPitch.timeCall === 'bad' ? 'bg-red-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Bad</button>
                        <button 
                            @click="currentPitch.timeCall = 'ok'"
                            :class="currentPitch.timeCall === 'ok' ? 'bg-yellow-500 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >OK</button>
                        <button 
                            @click="currentPitch.timeCall = 'good'"
                            :class="currentPitch.timeCall === 'good' ? 'bg-green-600 text-white' : 'bg-gray-200'"
                            class="py-3 rounded-lg font-medium outdoor-button transition"
                        >Good</button>
                    </div>
                </div>

                <!-- Button to move to count questions for Ball/Strike/Foul -->
                <button 
                    x-show="['ball', 'strike', 'foul'].includes(currentPitch.outcome) && !currentPitch.countAsked && isMainQuestionsComplete()"
                    @click="currentPitch.countAsked = true"
                    class="w-full mt-4 bg-blue-600 text-white text-xl font-bold py-4 rounded-lg outdoor-button hover:bg-blue-700 transition"
                >
                    Continue to Count Questions
                </button>

                <!-- Count Questions (shown after main questions) -->
                <div x-show="currentPitch.countAsked" class="border-t pt-4 mt-4">
                    <h3 class="font-bold text-lg mb-3">Count Questions</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block font-medium mb-2">Did they show the count with proper hand signals?</label>
                            <div class="flex gap-4">
                                <button 
                                    @click="currentPitch.gaveHandSignalCount = false"
                                    :class="currentPitch.gaveHandSignalCount === false ? 'bg-red-600 text-white' : 'bg-gray-200'"
                                    class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                                >No</button>
                                <button 
                                    @click="currentPitch.gaveHandSignalCount = true"
                                    :class="currentPitch.gaveHandSignalCount === true ? 'bg-green-600 text-white' : 'bg-gray-200'"
                                    class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                                >Yes</button>
                            </div>
                        </div>

                        <div>
                            <label class="block font-medium mb-2">Did they announce the count verbally?</label>
                            <div class="flex gap-4">
                                <button 
                                    @click="currentPitch.gaveVerbalCount = false"
                                    :class="currentPitch.gaveVerbalCount === false ? 'bg-red-600 text-white' : 'bg-gray-200'"
                                    class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                                >No</button>
                                <button 
                                    @click="currentPitch.gaveVerbalCount = true"
                                    :class="currentPitch.gaveVerbalCount === true ? 'bg-green-600 text-white' : 'bg-gray-200'"
                                    class="flex-1 py-3 rounded-lg font-medium outdoor-button transition"
                                >Yes</button>
                            </div>
                        </div>
                    </div>
                </div>

                <button 
                    x-show="isEvaluationComplete()"
                    @click="savePitch()"
                    class="w-full mt-4 bg-green-600 text-white text-xl font-bold py-4 rounded-lg outdoor-button hover:bg-green-700 transition"
                >
                    Next Pitch
                </button>
            </div>
        </div>

        <!-- Post-Game Summary -->
        <div x-show="currentScreen === 'postGame'" class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">Post-Game Summary</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block font-medium mb-2">Final demeanor rating:</label>
                    <div class="star-rating flex justify-center gap-2">
                        <template x-for="i in [1,2,3,4,5]" :key="i">
                            <div>
                                <input 
                                    type="radio" 
                                    :id="'post-star-' + i" 
                                    name="postDemeanor" 
                                    :value="i"
                                    @change="postGameData.demeanor = i"
                                >
                                <label 
                                    :for="'post-star-' + i"
                                    class="text-gray-300 cursor-pointer text-3xl"
                                    :class="postGameData.demeanor >= i ? 'text-yellow-400' : ''"
                                >‚òÖ</label>
                            </div>
                        </template>
                    </div>
                </div>

                <div>
                    <label class="block font-medium mb-2">Additional comments (optional):</label>
                    <textarea 
                        x-model="postGameData.comments"
                        rows="4"
                        class="w-full p-3 border rounded-lg"
                        placeholder="Any additional observations..."
                    ></textarea>
                </div>

                <div class="bg-gray-100 p-4 rounded-lg">
                    <h3 class="font-medium mb-2">Evaluation Summary</h3>
                    <div class="text-sm space-y-1">
                        <div>Total Pitches: <span x-text="pitches.length" class="font-bold"></span></div>
                        <div>Pre-Game Score: <span x-text="calculatePreGameScore() + '%'" class="font-bold"></span></div>
                        <div>Pitch Score: <span x-text="calculatePitchScore() + '%'" class="font-bold"></span></div>
                        <div class="text-lg mt-2">
                            Overall Score: <span x-text="calculateOverallScore() + '%'" class="font-bold text-blue-600"></span>
                        </div>
                    </div>
                </div>

                <button 
                    @click="submitEvaluation()"
                    :disabled="!postGameData.demeanor"
                    class="w-full bg-green-600 text-white text-xl font-bold py-4 rounded-lg outdoor-button hover:bg-green-700 disabled:bg-gray-400 transition"
                >
                    Submit Evaluation
                </button>
            </div>
        </div>

        <!-- Success Screen -->
        <div x-show="currentScreen === 'success'" class="bg-white rounded-lg shadow-lg p-6 text-center">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h2 class="text-2xl font-bold mb-2">Evaluation Submitted!</h2>
            <p class="text-gray-600 mb-6">Thank you for your evaluation.</p>
            <button 
                @click="reset()"
                class="w-full bg-blue-600 text-white text-xl font-bold py-4 rounded-lg outdoor-button hover:bg-blue-700 transition"
            >
                New Evaluation
            </button>
        </div>

        <!-- Loading Overlay -->
        <div x-show="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6">
                <div class="text-center">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        
        // Comment out for demo - uncomment when you have real credentials
        // const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function umpireApp() {
            return {
                // State
                currentScreen: 'login',
                loading: false,
                loginError: '',
                pin: '',
                evaluator: null,
                umpires: [],
                selectedUmpire: null,
                umpireSearch: '',
                pitchCount: 1,
                pitches: [],
                currentPitch: {
                    outcome: null,
                    location: null,
                    position: null,
                    handSignals: null,
                    timeCall: null,
                    gaveCount: null,
                    gaveVerbalCount: null,
                    gaveHandSignalCount: null,
                    fairBallSignal: null,
                    secondaryPlay: null,
                    callMade: null,
                    outfieldType: null,
                    announcedCall: null,
                    secondaryCallMade: null,
                    secondaryHandSignals: null,
                    secondaryPosition: null,
                    countAsked: false,
                    tags: [],
                    otherComment: ''
                },
                showingContextual: false,
                preGameData: {
                    onTime: null,
                    properUniform: null,
                    gameOnTime: null,
                    demeanor: null
                },
                postGameData: {
                    demeanor: null,
                    comments: ''
                },
                commentTags: [],

                // Computed
                get filteredUmpires() {
                    const search = this.umpireSearch.toLowerCase();
                    return this.umpires.filter(u => 
                        u.name.toLowerCase().includes(search) || 
                        u.email.toLowerCase().includes(search)
                    );
                },

                // Methods
                async init() {
                    // For demo, use mock data
                    this.umpires = [
                        { id: 1, name: 'John Smith', email: 'john.smith@example.com' },
                        { id: 2, name: 'Jane Doe', email: 'jane.doe@example.com' },
                        { id: 3, name: 'Mike Johnson', email: 'mike.j@example.com' },
                        { id: 4, name: 'Sarah Williams', email: 'sarah.w@example.com' }
                    ];
                },

                async login() {
                    if (this.pin.length !== 4) {
                        this.loginError = 'Please enter a 4-digit PIN';
                        return;
                    }

                    this.loading = true;
                    this.loginError = '';

                    // For demo, accept PIN 1234
                    if (this.pin === '1234') {
                        this.evaluator = { id: 1, name: 'Demo Evaluator', pin: '1234' };
                        this.currentScreen = 'selectUmpire';
                    } else {
                        this.loginError = 'Invalid PIN';
                    }

                    this.loading = false;
                },

                selectUmpire(umpire) {
                    this.selectedUmpire = umpire;
                    this.currentScreen = 'preGame';
                },

                isPreGameComplete() {
                    return this.preGameData.onTime !== null &&
                           this.preGameData.properUniform !== null &&
                           this.preGameData.gameOnTime !== null;
                },

                startPitchEvaluation() {
                    if (this.isPreGameComplete()) {
                        this.currentScreen = 'pitch';
                    }
                },

                selectOutcome(outcome) {
                    this.currentPitch.outcome = outcome;
                    if (outcome === 'ball') {
                        // Ball goes straight to count questions
                        this.showingContextual = true;
                        this.currentPitch.countAsked = true;
                    } else if (outcome !== 'inPlay') {
                        this.showContextualQuestions();
                    }
                },

                showContextualQuestions() {
                    this.showingContextual = true;
                },

                askOutfieldType() {
                    // Stay on pitch screen, just waiting for outfield type selection
                },

                setOutfieldType(type) {
                    this.currentPitch.outfieldType = type;
                    this.showContextualQuestions();
                },

                backFromOutfieldType() {
                    this.currentPitch.location = null;
                    this.currentScreen = 'pitch';
                },

                goBack() {
                    if (this.currentPitch.countAsked) {
                        // Going back from count questions
                        this.currentPitch.countAsked = false;
                    } else if (this.currentPitch.location && this.currentPitch.outcome === 'inPlay') {
                        // Going back from location selection
                        this.currentPitch.location = null;
                        this.currentPitch.outfieldType = null;
                        this.showingContextual = false;
                    } else if (this.showingContextual) {
                        // Going back from contextual questions
                        this.showingContextual = false;
                        this.currentPitch.outcome = null;
                        this.currentPitch.location = null;
                    }
                },

                getOutcomeDisplay() {
                    if (this.currentPitch.outcome === 'inPlay' && this.currentPitch.location) {
                        let display = `In Play - ${this.currentPitch.location}`;
                        if (this.currentPitch.outfieldType === 'caught') {
                            display += ' (Caught)';
                        } else if (this.currentPitch.outfieldType === 'nearLine') {
                            display += ' (Near Line)';
                        }
                        return display;
                    }
                    if (this.currentPitch.outcome === 'foul') {
                        return 'Foul Ball';
                    }
                    return this.currentPitch.outcome;
                },

                checkAutoProgressToCount() {
                    // Use setTimeout to ensure UI updates before checking
                    setTimeout(() => {
                        if (this.isMainQuestionsComplete() && !this.currentPitch.countAsked) {
                            this.currentPitch.countAsked = true;
                        }
                    }, 100);
                },

                isMainQuestionsComplete() {
                    if (this.currentPitch.outcome === 'ball') {
                        return true; // Ball has no main questions
                    }
                    if (this.currentPitch.outcome === 'strike') {
                        return this.currentPitch.handSignals !== null && 
                               this.currentPitch.announcedCall !== null;
                    }
                    if (this.currentPitch.outcome === 'foul') {
                        return this.currentPitch.position !== null &&
                               this.currentPitch.handSignals !== null &&
                               this.currentPitch.announcedCall !== null;
                    }
                    return false;
                },

                isEvaluationComplete() {
                    if (this.currentPitch.outcome === 'inPlay') {
                        if (this.currentPitch.location === 'infield') {
                            return this.currentPitch.callMade !== null &&
                                   this.currentPitch.handSignals !== null &&
                                   this.currentPitch.position !== null &&
                                   this.currentPitch.timeCall !== null;
                        }
                        if (this.currentPitch.location === 'outfield') {
                            // Base requirements for all outfield plays
                            let complete = this.currentPitch.secondaryPlay !== null;
                            
                            if (this.currentPitch.outfieldType === 'caught') {
                                complete = complete && 
                                          this.currentPitch.handSignals !== null &&
                                          this.currentPitch.announcedCall !== null &&
                                          this.currentPitch.position !== null;
                            }
                            
                            // Near line needs fair ball signal
                            if (this.currentPitch.outfieldType === 'nearLine') {
                                complete = complete && this.currentPitch.fairBallSignal !== null;
                            }
                            
                            // If there's a secondary play, check those questions too
                            if (this.currentPitch.secondaryPlay === true) {
                                complete = complete && 
                                          this.currentPitch.secondaryCallMade !== null &&
                                          this.currentPitch.secondaryHandSignals !== null &&
                                          this.currentPitch.secondaryPosition !== null;
                            }
                            
                            // All outfield plays need time call at the end
                            complete = complete && this.currentPitch.timeCall !== null;
                            
                            return complete;
                        }
                    }
                    // For ball, strike, foul - check if count questions are answered
                    if (['ball', 'strike', 'foul'].includes(this.currentPitch.outcome)) {
                        if (!this.currentPitch.countAsked) return false;
                        return this.currentPitch.gaveHandSignalCount !== null &&
                               this.currentPitch.gaveVerbalCount !== null;
                    }
                    return false;
                },

                toggleTag(tagId) {
                    const index = this.currentPitch.tags.indexOf(tagId);
                    if (index > -1) {
                        this.currentPitch.tags.splice(index, 1);
                    } else {
                        this.currentPitch.tags.push(tagId);
                    }
                },

                savePitch() {
                    this.pitches.push({...this.currentPitch});
                    
                    // Reset for next pitch
                    this.currentPitch = {
                        outcome: null,
                        location: null,
                        position: null,
                        handSignals: null,
                        timeCall: null,
                        gaveCount: null,
                        gaveVerbalCount: null,
                        gaveHandSignalCount: null,
                        fairBallSignal: null,
                        secondaryPlay: null,
                        callMade: null,
                        outfieldType: null,
                        announcedCall: null,
                        secondaryCallMade: null,
                        secondaryHandSignals: null,
                        secondaryPosition: null,
                        countAsked: false,
                        tags: [],
                        otherComment: ''
                    };
                    this.showingContextual = false;
                    this.pitchCount++;
                },

                endGame() {
                    if (confirm('Are you sure you want to end the game evaluation?')) {
                        this.currentScreen = 'postGame';
                    }
                },

                calculatePreGameScore() {
                    let score = 0;
                    let total = 0;

                    // Each question worth 33.33 points (100/3)
                    if (this.preGameData.onTime === true) score += 33.33;
                    total += 33.33;
                    
                    if (this.preGameData.properUniform === true) score += 33.33;
                    total += 33.33;
                    
                    if (this.preGameData.gameOnTime === true) score += 33.33;
                    total += 33.33;

                    return Math.round((score / total) * 100);
                },

                calculatePitchScore() {
                    if (this.pitches.length === 0) return 0;

                    let totalScore = 0;
                    let totalQuestions = 0;

                    this.pitches.forEach(pitch => {
                        // Position scoring
                        if (pitch.position !== null && pitch.position !== undefined) {
                            totalQuestions++;
                            if (pitch.position === 'good') totalScore += 1;
                            else if (pitch.position === 'ok') totalScore += 0.5;
                        }

                        // Hand signals scoring
                        if (pitch.handSignals !== null && pitch.handSignals !== undefined) {
                            totalQuestions++;
                            if (pitch.handSignals === 'proper') totalScore += 1;
                            else if (pitch.handSignals === 'improper') totalScore += 0.5;
                        }

                        // Time call scoring
                        if (pitch.timeCall !== null && pitch.timeCall !== undefined) {
                            totalQuestions++;
                            if (pitch.timeCall === 'good') totalScore += 1;
                            else if (pitch.timeCall === 'ok') totalScore += 0.5;
                        }

                        // Verbal count scoring
                        if (pitch.gaveVerbalCount !== null && pitch.gaveVerbalCount !== undefined) {
                            totalQuestions++;
                            if (pitch.gaveVerbalCount === true) totalScore += 1;
                        }

                        // Hand signal count scoring
                        if (pitch.gaveHandSignalCount !== null && pitch.gaveHandSignalCount !== undefined) {
                            totalQuestions++;
                            if (pitch.gaveHandSignalCount === true) totalScore += 1;
                        }

                        // Fair ball signal scoring
                        if (pitch.fairBallSignal !== null && pitch.fairBallSignal !== undefined) {
                            totalQuestions++;
                            if (pitch.fairBallSignal === true) totalScore += 1;
                        }

                        // Announced call scoring
                        if (pitch.announcedCall !== null && pitch.announcedCall !== undefined) {
                            totalQuestions++;
                            if (pitch.announcedCall === true) totalScore += 1;
                        }

                        // Secondary play hand signals
                        if (pitch.secondaryHandSignals !== null && pitch.secondaryHandSignals !== undefined) {
                            totalQuestions++;
                            if (pitch.secondaryHandSignals === 'proper') totalScore += 1;
                            else if (pitch.secondaryHandSignals === 'improper') totalScore += 0.5;
                        }

                        // Secondary play position
                        if (pitch.secondaryPosition !== null && pitch.secondaryPosition !== undefined) {
                            totalQuestions++;
                            if (pitch.secondaryPosition === 'good') totalScore += 1;
                            else if (pitch.secondaryPosition === 'ok') totalScore += 0.5;
                        }
                    });

                    if (totalQuestions === 0) return 100; // No questions asked = perfect score
                    return Math.max(0, Math.round((totalScore / totalQuestions) * 100));
                },

                calculateOverallScore() {
                    const preGameWeight = 0.2;
                    const pitchWeight = 0.6;
                    const postGameWeight = 0.2;

                    const preScore = this.calculatePreGameScore();
                    const pitchScore = this.calculatePitchScore();
                    const postScore = this.postGameData.demeanor ? (this.postGameData.demeanor / 5) * 100 : 0;

                    return Math.round(
                        (preScore * preGameWeight) +
                        (pitchScore * pitchWeight) +
                        (postScore * postGameWeight)
                    );
                },

                async submitEvaluation() {
                    if (!this.postGameData.demeanor) return;

                    this.loading = true;

                    const evaluationData = {
                        evaluator_id: this.evaluator.id,
                        umpire_id: this.selectedUmpire.id,
                        pre_game_data: this.preGameData,
                        pitches: this.pitches,
                        post_game_data: this.postGameData,
                        avg_score: this.calculateOverallScore(),
                        submitted_at: new Date().toISOString()
                    };

                    // For demo, just log the data
                    console.log('Evaluation submitted:', evaluationData);

                    // In production, save to Supabase:
                    // const { error } = await supabase
                    //     .from('final_evaluations')
                    //     .insert(evaluationData);

                    this.loading = false;
                    this.currentScreen = 'success';
                },

                reset() {
                    // Reset all data
                    this.currentScreen = 'selectUmpire';
                    this.selectedUmpire = null;
                    this.umpireSearch = '';
                    this.pitchCount = 1;
                    this.pitches = [];
                    this.currentPitch = {
                        outcome: null,
                        location: null,
                        position: null,
                        handSignals: null,
                        timeCall: null,
                        gaveCount: null,
                        gaveVerbalCount: null,
                        gaveHandSignalCount: null,
                        fairBallSignal: null,
                        secondaryPlay: null,
                        callMade: null,
                        outfieldType: null,
                        announcedCall: null,
                        secondaryCallMade: null,
                        secondaryHandSignals: null,
                        secondaryPosition: null,
                        countAsked: false,
                        tags: [],
                        otherComment: ''
                    };
                    this.showingContextual = false;
                    this.preGameData = {
                        onTime: null,
                        properUniform: null,
                        gameOnTime: null,
                        demeanor: null
                    };
                    this.postGameData = {
                        demeanor: null,
                        comments: ''
                    };
                }
            };
        }
    </script>
</body>
</html>